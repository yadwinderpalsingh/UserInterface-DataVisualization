<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Highcharts Example</title>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <link href="style.css" rel="stylesheet">
    <link href="slider.css" rel="stylesheet">
    <style type="text/css">
        #container {
            height: calc(100% - 80px);
            padding: 30px;
            width: 100%;
            margin: 0 auto;
        }
        
        html,
        body {
            height: 100%;
            width: 100%;
        }
        
        body {
            overflow: hidden;
            margin: 0;
        }
        
        * {
            box-sizing: border-box
        }
    </style>
  
</head>

<body>


    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>


    <div id="container"></div>
    <div class="filter">
        <input id="yearslider" type="text"  style="width:100%">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.1.3/bootstrap-slider.min.js"></script>
    <script type="text/javascript">
        var gender = ["Male", "Female"];
        var rawData = readData();
        var ageGroups;
        
        var chart;
        
        var options = {
            chart: {
                type: 'column',
                options3d: {
                    enabled: true,
                    alpha: 15,
                    beta: 15,
                    viewDistance: 25,
                    depth: 40,
                }
            },
            xAxis: {
                categories: []
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Age'
                }
            },
            tooltip: {
                headerFormat: '<b>{point.key}</b><br>',
                pointFormat: '<span style="color:{series.color}">\u25CF</span> {series.name}: {point.y} / {point.stackTotal}'
            },
            plotOptions: {
                column: {
                    stacking: 'normal',
                    depth: 40
                }
            }, 
            series: []
        };
        
      
        
        //options.xAxis.categories.push(readAgeGroups());
        //options.series.push(readData());
        //options.series.setData(data, false, true, true);
        

            //readDataFile(2000);

        
        var yearSlider = new Slider("#yearslider", {
            ticks: [1860, 1870, 1880, 1890, 1900, 1910, 1920, 1930, 1940, 1950, 1960, 1970, 1980, 1990, 2000],
            ticks_labels: ["1860", "1870", "1880", "1890", "1900", "1910", "1920", "1930", "1940", "1950", "1960", "1970", "1980", "1990", "2000" ],
            min: 1,
            max: 1,
            step: 1,
            value: 1860
        });
      
        yearSlider.on('change', function(){
         formatData(yearSlider.getValue());
        });
        
        var years = [];
        function readData(){
            $.get('population.csv', function (data) {
                rawData = data;
                formatData(1860);
                readAgeGroups()
            });
        }
        
        function formatData(year){
             // Split the lines
                var lines = rawData.split('\n');

                var maleobj = {
                    name: "Male"
                    , data: []
                    , stack: "male"
                };

                var femaleobj = {
                    name: "Female"
                    , data: []
                    , stack: "female"
                };

                $.each(lines, function (lineNo, line) {
                    var items = line.split(',');

                    // header line containes categories
                    if (lineNo > 0) {
                        //added years in an array
                        if(years.length == 0) {
                            years.push(parseInt(items[0]));
                        } else {
                            if (years[years.length-1] !== parseInt(items[0]) ) {
                                years.push(parseInt(items[0]));
                            }
                        }

                        // data by selected year
                        if (parseInt(items[0]) === year && items[2] === gender[0]) {
                            maleobj.data.push(parseInt(items[3]));
                        } else if (parseInt(items[0]) === year) {
                            femaleobj.data.push(parseInt(items[3]));
                        }                   
                    }

                });

                
                
                if (options.series.length > 0) {
                    chart = $('#container').highcharts();
                    chart.series[0].setData(maleobj);
                    chart.series[1].setData(femaleobj);
                } else {
                    options.series.push(maleobj);
                    options.series.push(femaleobj);
                    chart = $('#container').highcharts(options);
                }
        }
      
      
        //read age groups
        function readAgeGroups() {
            var ageGroups = [];
            
            // Split the lines
            var lines = rawData.split('\n');

            $.each(lines, function (lineNo, line) {
                var items = line.split(',');

                if (lineNo > 0) {
                    // age groups
                    if (ageGroups.length < 19) {
                        if (ageGroups.length == 0) {
                            ageGroups.push(parseInt(items[1]));
                        } else {
                            if (ageGroups[ageGroups.length - 1] !== parseInt(items[1])) {
                                ageGroups.push(parseInt(items[1]));
                            }
                        }
                    }                
                }

            });              
            options.xAxis.categories.push(ageGroups);
            
        }
      
    </script>
</body>

</html>